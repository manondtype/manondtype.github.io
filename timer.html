<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Manond Type Timer</title>
    <meta name="description" content="A professional focus timer for designers.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;600;800&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Manrope', 'sans-serif'] },
                    colors: {
                        accent: '#FF5C00', // Manond Orange
                        success: '#10B981', // Emerald Green for breaks
                        surface: {
                            light: '#FFFFFF',
                            dark: '#18181B' // Zinc 900
                        },
                        bg: {
                            light: '#F4F4F5', // Zinc 100
                            dark: '#09090B'  // Zinc 950
                        }
                    },
                    boxShadow: {
                        'glow': '0 0 20px rgba(255, 92, 0, 0.15)',
                        'glow-strong': '0 0 30px rgba(255, 92, 0, 0.3)',
                    }
                }
            }
        }
    </script>
    <style>
        body { 
            transition: background-color 0.5s ease, color 0.3s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Smooth Range Slider */
        input[type=range] {
            -webkit-appearance: none; background: transparent; cursor: pointer; height: 24px;
        }
        input[type=range]::-webkit-slider-runnable-track {
            background: rgba(150, 150, 150, 0.2); height: 4px; border-radius: 2px;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 16px; width: 16px; border-radius: 50%;
            background: currentColor; margin-top: -6px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: transform 0.1s;
        }
        input[type=range]::-webkit-slider-thumb:hover { transform: scale(1.1); }
        
        /* Timer SVG Styles */
        .timer-svg { transform: rotate(-90deg); }
        .progress-ring { transition: stroke-dashoffset 1s linear, stroke 0.5s ease; stroke-linecap: round; }
        
        /* Bar Graph Animation */
        .bar { transition: height 1s cubic-bezier(0.4, 0, 0.2, 1); min-height: 4px; border-radius: 4px; }
        
        /* Modal Backdrop */
        .modal-backdrop { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(16px); 
            -webkit-backdrop-filter: blur(16px);
        }
        .dark .modal-backdrop { background: rgba(0, 0, 0, 0.4); }

        /* Hide Scrollbar */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Soft Lockdown Blur */
        .soft-lockdown .controls-layer { opacity: 0.2; filter: blur(4px); pointer-events: none; transition: 0.5s; }
        .soft-lockdown .controls-layer:hover { opacity: 1; filter: blur(0); pointer-events: auto; }
    </style>
</head>
<body class="bg-bg-light dark:bg-bg-dark text-zinc-900 dark:text-zinc-100 h-screen flex flex-col overflow-hidden selection:bg-accent selection:text-white">

    <!-- Header / Nav -->
    <header class="absolute top-0 left-0 w-full p-6 flex justify-between items-start z-40">
        <div class="flex flex-col">
            <h1 class="font-extrabold tracking-tight text-lg leading-tight">Manond<br><span class="text-accent">Type Timer</span></h1>
            <div class="flex items-center gap-2 mt-2">
                <button id="ambientToggle" class="group flex items-center gap-2 text-xs font-semibold opacity-50 hover:opacity-100 transition-opacity">
                    <span class="w-2 h-2 rounded-full bg-zinc-400 group-[.active]:bg-green-500 transition-colors" id="ambientIndicator"></span>
                    <span id="ambientLabel">Focus Audio</span>
                </button>
            </div>
        </div>

        <div class="flex gap-3">
            <button id="statsBtn" class="p-3 rounded-2xl bg-white dark:bg-zinc-800 shadow-sm border border-zinc-200 dark:border-zinc-700 hover:scale-105 active:scale-95 transition-all text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-white" aria-label="Statistics">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            </button>
            <button id="settingsBtn" class="p-3 rounded-2xl bg-white dark:bg-zinc-800 shadow-sm border border-zinc-200 dark:border-zinc-700 hover:scale-105 active:scale-95 transition-all text-zinc-500 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-white" aria-label="Settings">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main id="appContainer" class="flex-1 flex flex-col items-center justify-center w-full max-w-2xl mx-auto px-6 relative">
        
        <!-- Timer Circle -->
        <div class="relative w-full max-w-[320px] aspect-square flex items-center justify-center mb-12">
            <svg class="timer-svg w-full h-full drop-shadow-xl" viewBox="0 0 100 100">
                <!-- Track -->
                <circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="2" fill="none" class="opacity-10"></circle>
                <!-- Progress -->
                <circle id="progress" cx="50" cy="50" r="45" stroke="currentColor" stroke-width="5" fill="none" class="text-accent progress-ring" stroke-dasharray="283" stroke-dashoffset="0"></circle>
            </svg>
            
            <div class="absolute inset-0 flex flex-col items-center justify-center z-10">
                <h2 id="timeDisplay" class="text-6xl md:text-8xl font-bold tracking-tighter tabular-nums leading-none">50:00</h2>
                <div class="mt-4 flex flex-col items-center">
                    <span id="statusLabel" class="text-xs font-bold uppercase tracking-[0.3em] opacity-40">Deep Work</span>
                </div>
            </div>
        </div>

        <!-- Controls Layer -->
        <div class="controls-layer w-full flex flex-col items-center gap-10">
            <!-- Buttons -->
            <div class="flex items-center gap-8 md:gap-12">
                <button id="resetBtn" class="text-xs font-bold uppercase tracking-widest opacity-40 hover:opacity-100 transition-opacity py-4">Reset</button>
                
                <button id="startBtn" class="h-16 px-10 rounded-full bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 font-bold text-sm uppercase tracking-widest shadow-lg hover:scale-105 hover:shadow-glow active:scale-95 transition-all flex items-center gap-3">
                    <span id="btnText">Start Session</span>
                </button>

                <button id="switchBtn" class="text-xs font-bold uppercase tracking-widest opacity-40 hover:opacity-100 transition-opacity py-4">Skip</button>
            </div>

            <!-- Session Dots -->
            <div id="sessionDots" class="flex gap-3 h-2"></div>
        </div>

    </main>

    <!-- ========= MODALS ========= -->

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 sm:p-6 modal-backdrop opacity-0 transition-opacity duration-300">
        <div class="bg-surface-light dark:bg-surface-dark w-full max-w-sm rounded-[32px] shadow-2xl border border-zinc-200 dark:border-zinc-800 p-8 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-center mb-8">
                <h3 class="text-xl font-bold tracking-tight">Studio Settings</h3>
                <button class="close-modal opacity-40 hover:opacity-100"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg></button>
            </div>

            <div class="space-y-8 overflow-y-auto max-h-[60vh] no-scrollbar pr-2">
                <!-- Theme -->
                <div class="space-y-3">
                    <label class="text-xs font-bold uppercase tracking-widest opacity-50">Theme</label>
                    <div class="grid grid-cols-3 gap-2 bg-zinc-100 dark:bg-zinc-800 p-1 rounded-xl">
                        <button class="theme-opt py-2 rounded-lg text-xs font-bold transition-all" data-theme="light">Light</button>
                        <button class="theme-opt py-2 rounded-lg text-xs font-bold transition-all" data-theme="dark">Dark</button>
                        <button class="theme-opt py-2 rounded-lg text-xs font-bold transition-all" data-theme="system">Auto</button>
                    </div>
                </div>

                <!-- Timers -->
                <div class="space-y-3">
                    <label class="text-xs font-bold uppercase tracking-widest opacity-50">Duration (Minutes)</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-zinc-50 dark:bg-zinc-900 p-3 rounded-2xl border border-zinc-200 dark:border-zinc-700 flex flex-col">
                            <span class="text-[10px] opacity-60 font-bold uppercase mb-1">Work</span>
                            <input type="number" id="workInput" class="bg-transparent font-bold text-xl outline-none w-full" value="50">
                        </div>
                        <div class="bg-zinc-50 dark:bg-zinc-900 p-3 rounded-2xl border border-zinc-200 dark:border-zinc-700 flex flex-col">
                            <span class="text-[10px] opacity-60 font-bold uppercase mb-1">Break</span>
                            <input type="number" id="breakInput" class="bg-transparent font-bold text-xl outline-none w-full" value="10">
                        </div>
                    </div>
                </div>

                <!-- Sound -->
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <label class="text-xs font-bold uppercase tracking-widest opacity-50">Sound Lab</label>
                        <span id="volPercent" class="text-xs font-mono opacity-50">30%</span>
                    </div>
                    <div class="bg-zinc-50 dark:bg-zinc-900 p-4 rounded-2xl border border-zinc-200 dark:border-zinc-700 space-y-4">
                        <div class="flex items-center gap-3">
                            <svg class="w-4 h-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                            <input type="range" id="volumeSlider" min="0" max="1" step="0.05" class="w-full text-accent">
                        </div>
                        <button id="testAlarmBtn" class="w-full py-2 rounded-lg border border-zinc-200 dark:border-zinc-700 text-xs font-bold uppercase tracking-widest hover:bg-zinc-200 dark:hover:bg-zinc-800 transition-colors">Test Alarm Bell</button>
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-4 border-t border-zinc-200 dark:border-zinc-800">
                <button id="saveSettings" class="w-full py-4 rounded-2xl bg-zinc-900 dark:bg-zinc-100 text-white dark:text-zinc-900 font-bold text-sm uppercase tracking-widest hover:scale-[1.02] active:scale-[0.98] transition-all">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Stats Modal -->
    <div id="statsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-backdrop opacity-0 transition-opacity duration-300">
        <div class="bg-surface-light dark:bg-surface-dark w-full max-w-sm rounded-[32px] shadow-2xl border border-zinc-200 dark:border-zinc-800 p-8 transform scale-95 transition-transform duration-300">
            <div class="flex justify-between items-start mb-10">
                <div>
                    <h3 class="text-2xl font-bold tracking-tight">Weekly<br>Analytics</h3>
                </div>
                <div class="text-right">
                    <span id="totalHours" class="text-4xl font-extrabold text-accent tracking-tighter">0.0</span>
                    <p class="text-[10px] font-bold uppercase tracking-widest opacity-40">Focus Hours</p>
                </div>
            </div>
            
            <div id="graphContainer" class="bar-container w-full items-end justify-between gap-2 h-32 mb-4"></div>
            <div id="graphLabels" class="flex justify-between px-1 mb-8"></div>
            
            <button class="close-modal w-full py-4 rounded-2xl bg-zinc-100 dark:bg-zinc-800 font-bold text-xs uppercase tracking-widest hover:bg-zinc-200 dark:hover:bg-zinc-700 transition-colors">Close</button>
        </div>
    </div>

    <!-- Health Modal -->
    <div id="healthModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 modal-backdrop opacity-0 transition-opacity duration-300">
        <div class="bg-surface-light dark:bg-surface-dark w-full max-w-sm rounded-[32px] shadow-2xl border border-zinc-200 dark:border-zinc-800 p-8 text-center transform scale-95 transition-transform duration-300">
            <div class="w-16 h-16 rounded-full bg-green-100 dark:bg-green-900/20 text-green-600 dark:text-green-400 flex items-center justify-center mx-auto mb-6">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
            </div>
            <h3 class="text-2xl font-bold mb-2">Block Complete</h3>
            <p class="text-sm opacity-60 mb-8 max-w-[200px] mx-auto leading-relaxed">Step away from the screen. Your eyes need this.</p>
            <button id="startBreakBtn" class="w-full py-4 rounded-2xl bg-accent text-white font-bold text-sm uppercase tracking-widest hover:shadow-lg hover:shadow-orange-500/20 hover:scale-[1.02] transition-all">Start Rest Timer</button>
        </div>
    </div>

    <!-- Audio Elements -->
    <audio id="alarmSound" src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3"></audio>

    <script>
        // --- Core State ---
        const getSaved = (k, d) => localStorage.getItem(k) || d;
        const setSaved = (k, v) => localStorage.setItem(k, v);

        const state = {
            workTime: parseInt(getSaved('workTime', 50)) * 60,
            breakTime: parseInt(getSaved('breakTime', 10)) * 60,
            dailyGoal: parseInt(getSaved('dailyGoal', 8)),
            theme: getSaved('theme', 'system'),
            stats: JSON.parse(getSaved('studioStats', '{}')),
            volume: parseFloat(getSaved('volume', 0.5)),
            
            timeLeft: 0,
            totalTime: 0,
            timerId: null,
            isWork: true,
            isAmbientPlaying: false
        };
        
        // Initialize State
        state.timeLeft = state.workTime;
        state.totalTime = state.workTime;

        // --- Audio Engine (Web Audio API) ---
        let audioCtx, brownNoiseNode, gainNode;

        function initAudio() {
            const AudioContext = window.AudioContext || window.webkitAudioContext;
            if (!audioCtx) audioCtx = new AudioContext();
            
            if (!gainNode) {
                gainNode = audioCtx.createGain();
                gainNode.gain.value = state.volume;
                gainNode.connect(audioCtx.destination);
            }
        }

        function toggleBrownNoise() {
            initAudio();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            if (!state.isAmbientPlaying) {
                const bufferSize = 4096;
                brownNoiseNode = audioCtx.createScriptProcessor(bufferSize, 1, 1);
                brownNoiseNode.onaudioprocess = (e) => {
                    const output = e.outputBuffer.getChannelData(0);
                    let lastOut = 0.0;
                    for (let i = 0; i < bufferSize; i++) {
                        const white = Math.random() * 2 - 1;
                        output[i] = (lastOut + (0.02 * white)) / 1.02;
                        lastOut = output[i];
                        output[i] *= 3.5; 
                    }
                };
                brownNoiseNode.connect(gainNode);
                state.isAmbientPlaying = true;
                
                document.getElementById('ambientToggle').classList.add('active');
                document.getElementById('ambientLabel').textContent = 'Audio Active';
                document.getElementById('ambientIndicator').classList.add('bg-green-500');
                document.getElementById('ambientIndicator').classList.remove('bg-zinc-400');
            } else {
                if (brownNoiseNode) brownNoiseNode.disconnect();
                state.isAmbientPlaying = false;
                
                document.getElementById('ambientToggle').classList.remove('active');
                document.getElementById('ambientLabel').textContent = 'Focus Audio';
                document.getElementById('ambientIndicator').classList.remove('bg-green-500');
                document.getElementById('ambientIndicator').classList.add('bg-zinc-400');
            }
        }

        // --- DOM Elements ---
        const els = {
            timeDisplay: document.getElementById('timeDisplay'),
            progressRing: document.getElementById('progress'),
            statusLabel: document.getElementById('statusLabel'),
            startBtn: document.getElementById('startBtn'),
            btnText: document.getElementById('btnText'),
            dotsContainer: document.getElementById('sessionDots'),
            body: document.body,
            alarm: document.getElementById('alarmSound')
        };

        // --- UI Functions ---
        
        function updateDisplay() {
            const m = Math.floor(state.timeLeft / 60);
            const s = state.timeLeft % 60;
            const timeStr = `${m}:${s < 10 ? '0' : ''}${s}`;
            
            els.timeDisplay.textContent = timeStr;
            document.title = state.timerId ? `${timeStr} â€¢ ${state.isWork ? 'Focus' : 'Rest'}` : 'Manond Type Timer';
            
            // Progress Ring
            const radius = 45;
            const circumference = 2 * Math.PI * radius;
            const offset = circumference - (state.timeLeft / state.totalTime) * circumference;
            els.progressRing.style.strokeDashoffset = offset;
            
            // Color Logic
            const accentColor = state.isWork ? '#FF5C00' : '#10B981';
            els.progressRing.style.color = accentColor;
            
            // Work Flow Gradient (Last 5 mins)
            if (state.isWork && state.timeLeft < 300 && state.timerId) {
                // Keep background clean, maybe pulse the ring or text
                els.timeDisplay.style.color = accentColor;
            } else {
                els.timeDisplay.style.color = '';
            }
        }

        function initDots() {
            els.dotsContainer.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            const completed = state.stats[today] || 0;
            
            for(let i=0; i<state.dailyGoal; i++) {
                const dot = document.createElement('div');
                dot.className = `w-2 h-2 rounded-full transition-all duration-300 ${i < completed ? 'bg-accent scale-110' : 'bg-current opacity-20'}`;
                els.dotsContainer.appendChild(dot);
            }
        }

        // --- Timer Engine ---

        function toggleTimer() {
            if (state.timerId) {
                clearInterval(state.timerId);
                state.timerId = null;
                els.btnText.textContent = 'Resume';
                els.startBtn.classList.remove('bg-zinc-900', 'dark:bg-zinc-100');
                els.startBtn.classList.add('bg-zinc-200', 'dark:bg-zinc-800', 'text-zinc-900', 'dark:text-white');
            } else {
                // Request Notification Permission
                if (Notification.permission === "default") Notification.requestPermission();
                
                state.timerId = setInterval(tick, 1000);
                els.btnText.textContent = 'Pause';
                els.startBtn.classList.add('bg-zinc-900', 'dark:bg-zinc-100');
                els.startBtn.classList.remove('bg-zinc-200', 'dark:bg-zinc-800', 'text-zinc-900', 'dark:text-white');
            }
        }

        function tick() {
            state.timeLeft--;
            updateDisplay();
            if (state.timeLeft <= 0) triggerAlarm();
        }

        function triggerAlarm() {
            clearInterval(state.timerId);
            state.timerId = null;
            
            els.alarm.volume = state.volume;
            els.alarm.play();
            
            if (state.isAmbientPlaying) toggleBrownNoise(); // Silence noise to hear alarm

            els.btnText.textContent = 'Stop Alarm';
            els.startBtn.classList.add('bg-red-500', 'text-white', 'animate-pulse');
            
            // Notify
            if (Notification.permission === "granted") {
                new Notification(state.isWork ? "Focus Complete" : "Break Over", {
                    body: state.isWork ? "Time to recharge." : "Ready to build?"
                });
            }
        }

        function stopAlarmAndProceed() {
            els.alarm.pause();
            els.alarm.currentTime = 0;
            els.startBtn.classList.remove('bg-red-500', 'text-white', 'animate-pulse');

            if (state.isWork) {
                // Log Data
                const today = new Date().toISOString().split('T')[0];
                state.stats[today] = (state.stats[today] || 0) + 1;
                setSaved('studioStats', JSON.stringify(state.stats));
                initDots();
                openModal('healthModal');
            } else {
                switchMode();
            }
        }

        function switchMode() {
            state.isWork = !state.isWork;
            state.timeLeft = state.isWork ? state.workTime : state.breakTime;
            state.totalTime = state.timeLeft;
            
            els.statusLabel.textContent = state.isWork ? 'Deep Work' : 'Recovery';
            els.btnText.textContent = 'Start Session';
            
            // Soft Lockdown Class
            if (!state.isWork) document.body.classList.add('soft-lockdown');
            else document.body.classList.remove('soft-lockdown');
            
            updateDisplay();
        }

        // --- Modals & Theme ---

        function openModal(id) {
            const m = document.getElementById(id);
            m.classList.remove('hidden');
            // Trigger reflow
            void m.offsetWidth;
            m.classList.remove('opacity-0');
            m.children[0].classList.remove('scale-95');
        }

        function closeModal(id) {
            const m = document.getElementById(id);
            m.classList.add('opacity-0');
            m.children[0].classList.add('scale-95');
            setTimeout(() => m.classList.add('hidden'), 300);
        }

        function renderStats() {
            const container = document.getElementById('graphContainer');
            const labels = document.getElementById('graphLabels');
            container.innerHTML = ''; labels.innerHTML = '';
            
            const days = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
            const curr = new Date();
            let totalSess = 0;
            
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(curr.getDate() - i);
                const dateStr = d.toISOString().split('T')[0];
                const count = state.stats[dateStr] || 0;
                totalSess += count;
                
                const height = Math.min((count / state.dailyGoal) * 100, 100);
                const isGoal = count >= state.dailyGoal;
                
                container.innerHTML += `<div class="flex-1 flex items-end h-full"><div class="bar w-full ${isGoal ? 'bg-accent' : 'bg-zinc-300 dark:bg-zinc-700'}" style="height: ${height || 5}%"></div></div>`;
                labels.innerHTML += `<div class="flex-1 text-center text-[10px] font-bold opacity-40">${days[d.getDay()]}</div>`;
            }
            
            document.getElementById('totalHours').textContent = ((totalSess * state.workTime) / 3600).toFixed(1);
        }

        // Theme Logic
        function setTheme(mode) {
            setSaved('theme', mode);
            document.documentElement.classList.remove('dark');
            
            // UI Update
            document.querySelectorAll('.theme-opt').forEach(b => {
                b.classList.remove('bg-white', 'dark:bg-zinc-600', 'shadow-sm');
                if(b.dataset.theme === mode) b.classList.add('bg-white', 'dark:bg-zinc-600', 'shadow-sm');
            });

            if (mode === 'dark' || (mode === 'system' && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
            }
        }

        // --- Event Listeners ---
        
        // Theme Buttons
        document.querySelectorAll('.theme-opt').forEach(btn => {
            btn.addEventListener('click', () => setTheme(btn.dataset.theme));
        });

        // Volume
        const volSlider = document.getElementById('volumeSlider');
        volSlider.value = state.volume;
        document.getElementById('volPercent').textContent = Math.round(state.volume * 100) + '%';
        
        volSlider.addEventListener('input', (e) => {
            state.volume = e.target.value;
            setSaved('volume', state.volume);
            document.getElementById('volPercent').textContent = Math.round(state.volume * 100) + '%';
            if (gainNode) gainNode.gain.value = state.volume;
        });

        document.getElementById('testAlarmBtn').addEventListener('click', () => {
            els.alarm.volume = state.volume;
            els.alarm.currentTime = 0;
            els.alarm.play();
            setTimeout(() => els.alarm.pause(), 2000);
        });

        // Main Controls
        els.startBtn.addEventListener('click', () => {
            if (!els.alarm.paused) stopAlarmAndProceed();
            else toggleTimer();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            clearInterval(state.timerId); state.timerId = null;
            state.timeLeft = state.totalTime;
            updateDisplay();
            els.btnText.textContent = 'Start Session';
        });

        document.getElementById('switchBtn').addEventListener('click', () => {
            if(!els.alarm.paused) { els.alarm.pause(); }
            switchMode();
        });
        
        document.getElementById('ambientToggle').addEventListener('click', toggleBrownNoise);

        // Modal Controls
        document.getElementById('settingsBtn').addEventListener('click', () => {
            document.getElementById('workInput').value = state.workTime / 60;
            document.getElementById('breakInput').value = state.breakTime / 60;
            openModal('settingsModal');
        });

        document.getElementById('statsBtn').addEventListener('click', () => {
            renderStats();
            openModal('statsModal');
        });

        document.getElementById('saveSettings').addEventListener('click', () => {
            state.workTime = document.getElementById('workInput').value * 60;
            state.breakTime = document.getElementById('breakInput').value * 60;
            setSaved('workTime', document.getElementById('workInput').value);
            setSaved('breakTime', document.getElementById('breakInput').value);
            setSaved('theme', getSaved('theme', 'system')); // Ensure theme saves
            
            // Reset if currently stopped
            if (!state.timerId) {
                state.timeLeft = state.isWork ? state.workTime : state.breakTime;
                state.totalTime = state.timeLeft;
                updateDisplay();
            }
            closeModal('settingsModal');
        });

        document.getElementById('startBreakBtn').addEventListener('click', () => {
            closeModal('healthModal');
            switchMode();
            toggleTimer();
        });

        document.querySelectorAll('.close-modal').forEach(b => {
            b.addEventListener('click', (e) => closeModal(e.target.closest('[id$="Modal"]').id));
        });

        // Init
        setTheme(state.theme);
        updateDisplay();
        initDots();

    </script>
</body>
</html>